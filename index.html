<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Swift Playground マップ検証ツール</title>
  <link rel="stylesheet" href="styles/main.css" />
</head>

<body>
  <!-- Fixed top bar for stepper controls and readouts -->
  <div class="topbar" id="stepperCard" role="region" aria-label="ステップ実行コントロール">
    <div class="topbar__section topbar__section--status">
      <!-- Status header moved here: acts as toggle to open the status details popover -->
      <button type="button" id="statusHeaderButton" class="status-header status-header--button" aria-haspopup="true" aria-expanded="false" aria-controls="statusCard" title="検証ステータス">
        <span class="status-pill" id="statusPill">未検証</span>
      </button>
    <strong class="topbar__status-heading" id="stepStatusHeading">結果待機中</strong>
  <span class="topbar__status-message" id="stepStatusMessage">検証が完了するとステップ実行が利用できます。</span>
  <span id="stepDetailMessage" class="topbar__status-detail">ステップごとのメッセージがここに表示されます。</span>
    </div>
    <div class="topbar__section topbar__section--readout" aria-live="polite">
      <span class="topbar__metric">ステップ <b id="stepIndexLabel">--</b></span>
      <span class="topbar__metric">位置 <b id="stepPositionLabel">--</b></span>
      <span class="topbar__metric">向き <b id="stepFacingLabel">--</b></span>
    </div>
    <div class="topbar__section topbar__section--controls">
      <button type="button" class="btn subtle small" id="stepStartButton" title="最初から">最初</button>
      <button type="button" class="btn ghost small" id="stepPrevButton" title="前へ">前</button>
      <button type="button" class="btn primary small" id="stepNextButton" title="次へ">次</button>
      <button type="button" class="btn ghost small" id="stepAutoButton" title="自動再生">自動再生</button>
    </div>
  </div>
  <div class="ambient"></div>
  <main class="app-shell" aria-labelledby="app-title">
    <header class="hero">
      <div class="hero-copy">
        <p class="eyebrow">Swift Playgrounds Toolkit</p>
        <h1 id="app-title">Swift Playground マップ検証ツール</h1>
        <p class="lead">
          Swift Playgrounds の「コードを学ぼう」向けに、マップと解答の整合性をブラウザ上で高速にチェックできます。
        </p>
      </div>
      <div class="hero-actions">
        <button type="button" class="btn ghost" id="loadSampleButton">例データを読み込む</button>
      </div>
    </header>

    <form id="validatorForm" class="input-shell" novalidate>

      <textarea id="solutionInput" name="solution" spellcheck="false" autocomplete="off" data-gramm="false"
        rows="12" placeholder="moveForward()&#10;collectGem()" hidden></textarea>

      <!-- Status card becomes a popover opened from the fixed header button -->
      <section class="card status-card" id="statusCard" data-status="idle" role="region" aria-labelledby="statusMessage" hidden>
        <div class="status-summary">
          <h2 id="statusMessage">マップとコードを入力すると自動的に検証されます。</h2>
          <p id="statusDetails">サンプルデータを読み込むと動作イメージを確認できます。</p>
        </div>
        <ul class="issue-list" id="issueList" hidden></ul>
        <div class="status-metrics">
          <div class="metric">
            <span class="metric-label">総ステップ</span>
            <span class="metric-value" id="metricSteps">0</span>
          </div>
          <div class="metric">
            <span class="metric-label">ジェム</span>
            <span class="metric-value" id="metricGems">0 / 0</span>
          </div>
          <div class="metric">
            <span class="metric-label">スイッチ</span>
            <span class="metric-value" id="metricSwitches">0 / 0</span>
          </div>
          <div class="metric">
            <span class="metric-label">エラー</span>
            <span class="metric-value" id="metricErrors">0</span>
          </div>
        </div>
        <div class="status-actions">
          <!-- レポートボタンは検証ログ周辺へ移動しました -->
          <button type="button" class="btn subtle" id="statusLogButton">検証ログ</button>
        </div>
      </section>
    </form>

    <!-- Stepper content moved to fixed top bar; container kept logically via topbar -->
    <button type="button" class="btn ghost" id="clearInputsButton">入力をクリア</button>
    <!-- Map and Code panels displayed side-by-side -->
    <div class="panel-grid">
    <section class="card map-card" aria-live="polite">
      <header class="map-card-header">
        <div class="map-card-heading">
          <h2>マップ</h2>
        </div>
        <div class="map-card-actions">
          <button type="button" class="btn ghost" id="legendToggleButton" aria-haspopup="true" aria-expanded="false" aria-controls="legendPopover">凡例</button>
        </div>
      </header>
      <div id="legendPopover" class="legend-popover" role="region" aria-labelledby="legendPopoverTitle" hidden>
        <div class="legend-popover__inner">
          <div class="legend-popover__header">
            <h3 id="legendPopoverTitle">凡例</h3>
            <button type="button" class="btn subtle small" id="legendCloseButton" aria-label="凡例を閉じる">閉じる</button>
          </div>
          <dl class="legend-list">
            <div>
              <dt><span class="legend-icon" aria-hidden="true">🧱</span><span class="legend-token">止</span></dt>
              <dd>通行不可ブロック</dd>
            </div>
            <div>
              <dt><span class="legend-icon" aria-hidden="true">⬆️</span><span class="legend-token">↑ ↓ ← →</span></dt>
              <dd>キャラクター初期位置と向き</dd>
            </div>
            <div>
              <dt><span class="legend-icon" aria-hidden="true">💎</span><span class="legend-token">♦</span></dt>
              <dd>ジェム</dd>
            </div>
            <div>
              <dt><span class="legend-icon" aria-hidden="true">🟢 / 🔴</span><span class="legend-token">〇 / ●</span></dt>
              <dd>スイッチ（開 / 閉）</dd>
            </div>
            <div>
              <dt><span class="legend-icon" aria-hidden="true">🌀</span><span class="legend-token">W1, W2 …</span></dt>
              <dd>ワープポータル（同番号間で移動）</dd>
            </div>
            <div>
              <dt><span class="legend-icon" aria-hidden="true">▫️</span><span class="legend-token">空欄</span></dt>
              <dd>通行可能な床</dd>
            </div>
          </dl>
        </div>
      </div>
      <div class="map-size-toolbar" aria-live="polite">
        <form id="mapSizeForm" class="map-size-form" novalidate>
          <div class="map-size-fields" role="group" aria-label="マップの行数と列数">
            <label class="map-size-field" for="mapRowsInput">
              <span>行</span>
              <input type="number" inputmode="numeric" min="1" id="mapRowsInput" name="rows" placeholder="行数" />
            </label>
            <span class="map-size-multiply" aria-hidden="true">×</span>
            <label class="map-size-field" for="mapColsInput">
              <span>列</span>
              <input type="number" inputmode="numeric" min="1" id="mapColsInput" name="cols" placeholder="列数" />
            </label>
          </div>
          <div class="map-size-actions">
            <button type="submit" class="btn subtle" id="mapSizeApplyButton">サイズを更新</button>
          </div>
        </form>
        <p class="map-size-note">左上を基点に拡縮し、拡張部分は通行不可ブロックで埋め、縮小で外れたマスは無効化します。</p>
      </div>
      <div class="map-preview-grid">
        <div id="mapCanvas" class="map-canvas" role="grid" aria-label="マップのプレビュー"></div>
      </div>
      <!-- Move: 'テキストで編集' button relocated here so it appears below the map preview -->
      <div class="map-card-footer">
        <button type="button" class="btn ghost" id="mapTextEditorButton">テキストで編集</button>
      </div>
    </section>

    <!-- Independent code card placed next to the map card; toggle moved outside the card frame -->
    <div class="code-column">
      <section class="card code-card" aria-live="polite">
        <header class="code-card-header">
          <h2>コード</h2>
          <button type="button" class="btn ghost" id="codePanelToggleButton" aria-pressed="false">コードを編集</button>
        </header>
        <div class="code-panel" id="codePanel">
          <div class="code-panel-header">
            <div class="code-panel-header-main">
              <h3>実行中のコード</h3>
              <span class="code-panel-hint" id="codePanelHint">入力した Swift コードがここに表示されます。</span>
            </div>
            <div class="code-panel-actions">
              <span class="chip" id="commandCountChip" aria-live="polite">0 コマンド</span>
            </div>
          </div>
          <div class="code-panel-body" role="region" aria-live="polite">
            <ol class="code-viewer-list" id="codeLineList"></ol>
            <textarea id="codePanelEditor" class="code-panel-editor" spellcheck="false" autocomplete="off"
              data-gramm="false" hidden></textarea>
          </div>
        </div>
      </section>
    </div>
    </div>

    <div class="map-text-modal" id="mapTextModal" role="dialog" aria-modal="true"
      aria-labelledby="mapTextModalTitle" hidden>
      <div class="map-text-modal__dialog">
        <header class="map-text-modal__header">
          <div>
            <h2 id="mapTextModalTitle">マップをテキストで編集</h2>
            <p class="map-text-modal__description">
              タブ区切りでマスを指定します。変更は即座にプレビューへ反映されます。
            </p>
          </div>
          <button type="button" class="btn ghost" id="mapTextModalCloseButton">閉じる</button>
        </header>
        <div class="map-text-modal__body">
          <textarea id="mapInput" name="map" spellcheck="false" autocomplete="off" data-gramm="false" rows="14"
            placeholder="止	止	止	→			♦"></textarea>
        </div>
      </div>
    </div>

    <div class="log-modal" id="logModal" role="dialog" aria-modal="true" aria-labelledby="logModalTitle" hidden>
      <div class="log-modal__dialog">
        <header class="log-modal__header">
          <div>
            <h2 id="logModalTitle">検証ログ</h2>
            <p class="log-modal__description">実行ログとステップ情報を確認できます。</p>
          </div>
          <div class="log-tools">
            <button type="button" class="btn ghost" id="expandLogButton">展開</button>
            <button type="button" class="btn ghost" id="collapseLogButton">折りたたむ</button>
            <button type="button" class="btn subtle" id="downloadReportButton" title="現在の検証結果を保存">レポートを保存</button>
            <button type="button" class="btn ghost" id="logModalCloseButton">閉じる</button>
          </div>
        </header>
        <div class="log-modal__body">
          <ol id="logList" class="log-list" aria-live="polite" tabindex="-1"></ol>
        </div>
      </div>
    </div>

    <footer class="app-footer">
      <p>© 2025 Swift Playground Toolkit. ローカルブラウザのみで動作し、入力データは保存されません。</p>
    </footer>
  </main>

  <noscript class="no-script">このアプリを利用するには JavaScript を有効にしてください。</noscript>
  <script src="scripts/app.js" type="module"></script>
</body>

</html>